
<!DOCTYPE html>
<html>
<head>
    <title>MAS-FRO Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand">MAS-FRO: Multi-Agent Flood Route Optimization</span>
            <span class="navbar-text" id="status">System Status: <span class="badge bg-success">Active</span></span>
        </div>
    </nav>
    
    <div class="container-fluid mt-3">
        <div class="row">
            <!-- System Status Panel -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5>System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong>Active Agents:</strong> <span id="agents-count">0</span>
                        </div>
                        <div class="mb-2">
                            <strong>Routes Computed:</strong> <span id="routes-count">0</span>
                        </div>
                        <div class="mb-2">
                            <strong>Success Rate:</strong> <span id="success-rate">0%</span>
                        </div>
                        <div class="mb-2">
                            <strong>Avg Response Time:</strong> <span id="response-time">0ms</span>
                        </div>
                    </div>
                </div>
                
                <!-- Route Request Panel -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Request Route</h5>
                    </div>
                    <div class="card-body">
                        <form id="route-form">
                            <div class="mb-2">
                                <label class="form-label">Origin Latitude</label>
                                <input type="number" class="form-control" id="origin-lat" 
                                       value="14.6507" step="0.0001" required>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Origin Longitude</label>
                                <input type="number" class="form-control" id="origin-lon" 
                                       value="121.1029" step="0.0001" required>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">User ID</label>
                                <input type="text" class="form-control" id="user-id" 
                                       value="web_user_1" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Request Route</button>
                        </form>
                        <div id="route-result" class="mt-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- Map Panel -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Real-time Flood Risk Map</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="map" style="height: 600px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Panel -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5>Performance Metrics</h5>
                    </div>
                    <div class="card-body">
                        <div id="performance-chart" style="height: 300px;"></div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <div id="activity-log" style="height: 250px; overflow-y: auto;">
                            <!-- Activity items will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize map
        var map = L.map('map').setView([14.6507, 121.1029], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        // Initialize performance chart
        var performanceData = {
            x: [],
            y: [],
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Response Time'
        };
        
        Plotly.newPlot('performance-chart', [performanceData], {
            title: 'Response Time Trend',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Response Time (ms)' }
        });
        
        // Update functions
        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('agents-count').textContent = data.agents_active || 5;
                    document.getElementById('routes-count').textContent = data.routes_computed || 0;
                    document.getElementById('success-rate').textContent = 
                        ((data.success_rate || 0) * 100).toFixed(1) + '%';
                    document.getElementById('response-time').textContent = 
                        ((data.avg_computation_time || 0) * 1000).toFixed(0) + 'ms';
                });
        }
        
        function updateMap() {
            fetch('/api/map')
                .then(response => response.json())
                .then(data => {
                    // Clear existing layers
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.Circle || layer instanceof L.Polyline) {
                            map.removeLayer(layer);
                        }
                    });
                    
                    // Add risk zones
                    if (data.risk_zones) {
                        data.risk_zones.forEach(zone => {
                            var color = zone.risk > 0.7 ? 'red' : zone.risk > 0.4 ? 'orange' : 'yellow';
                            L.circle([zone.lat, zone.lon], {
                                color: color,
                                fillColor: color,
                                fillOpacity: 0.3,
                                radius: zone.radius || 200
                            }).addTo(map).bindPopup(`Risk Level: ${(zone.risk * 100).toFixed(0)}%`);
                        });
                    }
                    
                    // Add active routes
                    if (data.active_routes) {
                        data.active_routes.forEach(route => {
                            L.polyline(route.path, {color: 'blue', weight: 3}).addTo(map)
                                .bindPopup(`Route ID: ${route.id}<br>Safety Score: ${route.safety_score.toFixed(2)}`);
                        });
                    }
                });
        }
        
        function updatePerformance() {
            fetch('/api/performance')
                .then(response => response.json())
                .then(data => {
                    if (data.avg_computation_time) {
                        performanceData.x.push(new Date());
                        performanceData.y.push(data.avg_computation_time * 1000);
                        
                        // Keep only last 20 points
                        if (performanceData.x.length > 20) {
                            performanceData.x.shift();
                            performanceData.y.shift();
                        }
                        
                        Plotly.redraw('performance-chart');
                    }
                });
        }
        
        function addActivityLog(message) {
            var log = document.getElementById('activity-log');
            var item = document.createElement('div');
            item.className = 'alert alert-info alert-sm mb-1';
            item.innerHTML = `<small>${new Date().toLocaleTimeString()}</small><br>${message}`;
            log.insertBefore(item, log.firstChild);
            
            // Keep only last 10 items
            while (log.children.length > 10) {
                log.removeChild(log.lastChild);
            }
        }
        
        // Route request form
        document.getElementById('route-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var requestData = {
                origin_lat: parseFloat(document.getElementById('origin-lat').value),
                origin_lon: parseFloat(document.getElementById('origin-lon').value),
                user_id: document.getElementById('user-id').value
            };
            
            fetch('/api/request_route', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('route-result').innerHTML = 
                    `<div class="alert alert-success">Route requested: ${data.request_id}</div>`;
                addActivityLog(`Route requested for user ${requestData.user_id}`);
            })
            .catch(error => {
                document.getElementById('route-result').innerHTML = 
                    `<div class="alert alert-danger">Error: ${error}</div>`;
            });
        });
        
        // Auto-update every 5 seconds
        setInterval(() => {
            updateStatus();
            updateMap();
            updatePerformance();
        }, 5000);
        
        // Initial load
        updateStatus();
        updateMap();
        updatePerformance();
        addActivityLog('Dashboard initialized');
    </script>
</body>
</html>
        